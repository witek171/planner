services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: planner_sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong@Password123
      - MSSQL_PID=Express
      - MSSQL_COLLATION=SQL_Latin1_General_CP1_CI_AS
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - planner_network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong@Password123' -C -Q 'SELECT 1'" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  db_init:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: planner_db_init
    environment:
      - SA_PASSWORD=YourStrong@Password123
    volumes:
      - ./Database:/scripts:ro
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - planner_network
    command: >
      bash -c "
        echo 'Czekanie na gotowość SQL Server...'
        sleep 30
        echo 'Wykonywanie skryptu inicjalizacji bazy danych...'
        /opt/mssql-tools18/bin/sqlcmd -S sqlserver -U sa -P 'YourStrong@Password123' -C -i /scripts/DatabaseSetup.sql -o /tmp/setup.log
        if [ \$$? -eq 0 ]; then
          echo 'DatabaseSetup.sql wykonano pomyślnie!'
          echo 'Dodawanie przykładowych danych...'
          /opt/mssql-tools18/bin/sqlcmd -S sqlserver -U sa -P 'YourStrong@Password123' -C -i /scripts/InsertSampleData.sql -o /tmp/sample.log
          if [ \$$? -eq 0 ]; then
            echo 'InsertSampleData.sql wykonano pomyślnie!'
            echo 'Inicjalizacja bazy danych zakończona!'
          else
            echo 'Błąd podczas wykonywania InsertSampleData.sql'
            cat /tmp/sample.log
            exit 1
          fi
        else
          echo 'Błąd podczas wykonywania DatabaseSetup.sql'
          cat /tmp/setup.log
          exit 1
        fi
        echo 'Kontener inicjalizacyjny zakończył pracę - można go usunąć'
      "

  key_generator:
    image: alpine:latest
    container_name: planner_key_generator
    volumes:
      - ./Schedule.API/Data:/keys
    command: >
      sh -c "
        apk add --no-cache openssl &&
        if [ ! -f /keys/private.key ] || [ ! -f /keys/public.key ]; then
          echo 'Generowanie kluczy RSA...' &&
          openssl genrsa -out /keys/private.key 2048 &&
          openssl rsa -in /keys/private.key -pubout -out /keys/public.key &&
          chmod 644 /keys/private.key &&
          chmod 644 /keys/public.key &&
          echo 'Klucze RSA zostały wygenerowane!'
        else
          echo 'Klucze RSA już istnieją.'
        fi
      "

  schedule_api:
    build:
      context: .
      dockerfile: Schedule.API/Dockerfile
    container_name: planner_api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver,1433;Database=PlannerDB;User Id=sa;Password=YourStrong@Password123;TrustServerCertificate=True;MultipleActiveResultSets=True;
      - PasswordPepper=MojaSuperSekretnaPepper123!
      - Jwt__Issuer=Schedule.Auth
      - Jwt__Audience=Schedule.Api
      - Jwt__ExpiresInMinutes=240
    ports:
      - "5000:8080"
    volumes:
      - ./Schedule.API/Data:/app/data:ro
    depends_on:
      db_init:
        condition: service_completed_successfully
      sqlserver:
        condition: service_healthy
      key_generator:
        condition: service_completed_successfully
    networks:
      - planner_network
    restart: unless-stopped

volumes:
  sqlserver_data:
    driver: local

networks:
  planner_network:
    driver: bridge